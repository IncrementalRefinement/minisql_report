<div class="cover" style="page-break-after:always;font-family:æ–¹æ­£å…¬æ–‡ä»¿å®‹;width:100%;height:100%;border:none;margin: 0 auto;text-align:center;">
    <div style="width:60%;margin: 0 auto;height:0;padding-bottom:10%;">
        </br>
        <img src="%E6%A0%A1%E5%90%8D-%E9%BB%91%E8%89%B2.svg" alt="æ ¡å" style="width:100%;"/>
    </div>
    </br></br></br></br></br>
    <div style="width:60%;margin: 0 auto;height:0;padding-bottom:40%;">
        <img src="%E6%A0%A1%E5%BE%BD-%E9%BB%91%E8%89%B2.svg" alt="æ ¡å¾½" style="width:100%;"/>
	</div>
    </br></br></br></br></br></br></br></br>
    <span style="font-family:åæ–‡é»‘ä½“Bold;text-align:center;font-size:20pt;margin: 10pt auto;line-height:30pt;">ã€ŠMiniSQLæ€»ä½“è®¾è®¡æŠ¥å‘Šã€‹</span>
    <p style="text-align:center;font-size:14pt;margin: 0 auto">è¯¾ç¨‹ä½œä¸šæŠ¥å‘Š </p>
    </br>
    </br>
    <table style="border:none;text-align:center;width:72%;font-family:ä»¿å®‹;font-size:14px; margin: 0 auto;">
    <tbody style="font-family:æ–¹æ­£å…¬æ–‡ä»¿å®‹;font-size:12pt;">
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">é¢˜ã€€ã€€ç›®</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹"> MiniSQLæ€»ä½“è®¾è®¡æŠ¥å‘Š</td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">ä¸Šè¯¾æ—¶é—´</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹"> å‘¨äºŒä¸‹åˆ</td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">æˆè¯¾æ•™å¸ˆ</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹">é™ˆåˆš </td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">æˆã€€ã€€å‘˜</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹"> é™†å¤©-3180103740</td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">æˆã€€ã€€å‘˜</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹">å•ä¸¹ç‘œ-3190101348 </td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">æˆã€€ã€€å‘˜</td>
    		<td style="width:%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹"> æ—ç‚¬ä¹™-3180103721</td>     </tr>
    	<tr style="font-weight:normal;"> 
    		<td style="width:20%;text-align:right;">æ—¥ã€€ã€€æœŸ</td>
    		<td style="width:2%">ï¼š</td> 
    		<td style="width:40%;font-weight:normal;border-bottom: 1px solid;text-align:center;font-family:åæ–‡ä»¿å®‹">å®Œæˆæ—¥æœŸ</td>     </tr>
    </tbody>              
    </table>
</div>

<!-- æ³¨é‡Šè¯­å¥ï¼šå¯¼å‡ºPDFæ—¶ä¼šåœ¨è¿™é‡Œåˆ†é¡µ -->


# **MiniSQLæ€»ä½“è®¾è®¡æŠ¥å‘Š**

## MiniSQLç³»ç»Ÿæ¦‚è¿°

### èƒŒæ™¯

#### ç¼–å†™ç›®çš„

â€‹	è®¾è®¡å¹¶å®ç°ä¸€ä¸ªç²¾ç®€å‹å•ç”¨æˆ·SQLå¼•æ“MiniSQLï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å­—ç¬¦ç•Œé¢è¾“å…¥SQLè¯­å¥å®ç°åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå¹¶èƒ½å¤Ÿé€šè¿‡ç´¢å¼•æ¥ä¼˜åŒ–æ€§èƒ½ã€‚

#### é¡¹ç›®èƒŒæ™¯

â€‹	é€šè¿‡å¯¹MiniSQLçš„è®¾è®¡ä¸å®ç°ï¼Œæé«˜æˆ‘ä»¬å¯¹ç³»ç»Ÿç¼–ç¨‹èƒ½åŠ›ï¼ŒåŠ æ·±å¯¹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿåº•å±‚è®¾è®¡çš„ç†è§£ã€‚



###  åŠŸèƒ½æè¿°

1. æ•°æ®ç±»å‹ï¼šè¦æ±‚æ”¯æŒä¸‰ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼š`integer`ï¼Œ`char(n)`ï¼Œ`float`ã€‚
2. è¡¨å®šä¹‰ï¼šä¸€ä¸ªè¡¨å¯ä»¥å®šä¹‰å¤šè¾¾32ä¸ªå±æ€§ï¼Œå„å±æ€§å¯ä»¥æŒ‡å®šæ˜¯å¦ä¸º`unique`ï¼Œæ”¯æŒå•å±æ€§çš„ä¸»é”®å®šä¹‰ã€‚
3. ç´¢å¼•å®šä¹‰ï¼šå¯¹äºè¡¨çš„ä¸»å±æ€§è‡ªåŠ¨å»ºç«‹B+æ ‘ç´¢å¼•ï¼Œå¯¹äºå£°æ˜ä¸º`unique`çš„å±æ€§ä¹Ÿéœ€è¦å»ºç«‹B+æ ‘ç´¢å¼•ã€‚
4. æ•°æ®æ“ä½œ: å¯ä»¥é€šè¿‡`and`æˆ–`or`è¿æ¥çš„å¤šä¸ªæ¡ä»¶è¿›è¡ŒæŸ¥è¯¢ï¼Œæ”¯æŒç­‰å€¼æŸ¥è¯¢å’ŒåŒºé—´æŸ¥è¯¢ã€‚æ”¯æŒæ¯æ¬¡ä¸€æ¡è®°å½•çš„æ’å…¥æ“ä½œï¼›æ”¯æŒæ¯æ¬¡ä¸€æ¡æˆ–å¤šæ¡è®°å½•çš„åˆ é™¤æ“ä½œã€‚
5. åœ¨å·¥ç¨‹å®ç°ä¸Šï¼Œä½¿ç”¨æºä»£ç ç®¡ç†å·¥å…·ï¼ˆGit-Labï¼‰è¿›è¡Œä»£ç ç®¡ç†ï¼Œä»£ç æäº¤å†å²å’Œæ¯æ¬¡æäº¤çš„ä¿¡æ¯æ¸…æ™°æ˜ç¡®ï¼›åŒæ—¶ç¼–å†™çš„ä»£ç åº”ç¬¦åˆä»£ç è§„èŒƒï¼Œå…·æœ‰è‰¯å¥½çš„ä»£ç é£æ ¼ã€‚



### è¿è¡Œç¯å¢ƒå’Œé…ç½®

- `apple clang`: 11.0+ (MacOS)ï¼Œä½¿ç”¨`gcc --version`å’Œ`g++ --version`æŸ¥çœ‹
- `gcc`&`g++` : 8.0+ (Linux)ï¼Œä½¿ç”¨`gcc --version`å’Œ`g++ --version`æŸ¥çœ‹
- `cmake`: 3.16+ (Both)ï¼Œä½¿ç”¨`cmake --version`æŸ¥çœ‹
- `gdb`: 7.0+ (Optional)ï¼Œä½¿ç”¨`gdb --version`æŸ¥çœ‹
- `flex`& `bison`(æš‚æ—¶ä¸éœ€è¦å®‰è£…ï¼Œä½†å¦‚æœéœ€è¦å¯¹SQLç¼–è¯‘å™¨çš„è¯­æ³•è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦å®‰è£…ï¼‰

æœ¬ç»„ï¼š

- å•ä¸¹ç‘œ-ç³»ç»Ÿï¼šM1æ¶æ„ä¸‹çš„MacOSï¼Œç¯å¢ƒé…ç½®ï¼šclang + lldbï¼ŒIdeï¼šCLion + VS Code
- é™†å¤©ï¼š
- æ—ç‚¬ä¹™ï¼š



###   å‚è€ƒèµ„æ–™

1. è¯­é›€æ–‡æ¡£ğŸ“–ï¼šhttps://www.yuque.com/yingchengjun/pcp6qx/fggii4
2. é“¾æ¥ğŸ”—ï¼šhttp://db.cs.berkeley.edu/papers/fntdb07-architecture.pdf
3. CMUç½‘è¯¾ğŸŒ²ï¼šhttps://www.bilibili.com/video/BV1VL411w72p?p=5 
3. æœ¬ç»„è¯­é›€çŸ¥è¯†åº“ğŸ¦œï¼šhttps://zg3aga.yuque.com/hbre0c



##    MiniSQLç³»ç»Ÿç»“æ„è®¾è®¡

###  æ€»ä½“è®¾è®¡ï¼š

#### ç³»ç»Ÿæ¶æ„ç¤ºæ„å›¾

- åœ¨ç³»ç»Ÿæ¶æ„ä¸­ï¼Œè§£é‡Šå™¨`SQL Parser`åœ¨è§£æSQLè¯­å¥åå°†ç”Ÿæˆçš„è¯­æ³•æ ‘äº¤ç”±æ‰§è¡Œå™¨`Executor`å¤„ç†ã€‚æ‰§è¡Œå™¨åˆ™æ ¹æ®è¯­æ³•æ ‘çš„å†…å®¹å¯¹ç›¸åº”çš„æ•°æ®åº“å®ä¾‹ï¼ˆ`DB Storage Engine Instance`ï¼‰è¿›è¡Œæ“ä½œã€‚
- æ¯ä¸ª`DB Storage Engine Instance`å¯¹åº”äº†ä¸€ä¸ªæ•°æ®åº“å®ä¾‹ï¼ˆå³é€šè¿‡`CREATE DATABSAE`åˆ›å»ºçš„æ•°æ®åº“ï¼‰ã€‚åœ¨æ¯ä¸ªæ•°æ®åº“å®ä¾‹ä¸­ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰è‹¥å¹²è¡¨å’Œç´¢å¼•ï¼Œè¡¨å’Œç´¢å¼•çš„ä¿¡æ¯é€šè¿‡`Catalog Manager`ã€`Index Manager`å’Œ`Record Manager`è¿›è¡Œç»´æŠ¤ã€‚ç›®å‰ç³»ç»Ÿæ¶æ„ä¸­å·²ç»æ”¯æŒä½¿ç”¨å¤šä¸ªæ•°æ®åº“å®ä¾‹ï¼Œä¸åŒçš„æ•°æ®åº“å®ä¾‹å¯ä»¥é€šè¿‡`USE`è¯­å¥åˆ‡æ¢ï¼ˆå³ç±»ä¼¼äºMySQLçš„åˆ‡æ¢æ•°æ®åº“ï¼‰ï¼Œåœ¨åˆæ­¥å®ç°æ—¶ï¼Œå¯ä»¥å…ˆè€ƒè™‘å•ä¸ªæ•°æ®åº“å®ä¾‹çš„åœºæ™¯ï¼Œåœ¨å•ä¸ªå®ä¾‹è·‘é€šåå†æ”¯æŒå¤šä¸ªå®ä¾‹ã€‚

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/1648365471553-1ceac0a4-e909-42c8-8bb9-516409e03492.png" alt="image.png" style="zoom:50%;" />

### DISK AND BUFFER POOL MANAGER æ¨¡å—ï¼š

â€‹	Disk Managerå’ŒBuffer Pool Manageræ¨¡å—ä½äºæ¶æ„çš„æœ€åº•å±‚ã€‚Disk Managerä¸»è¦è´Ÿè´£æ•°æ®åº“æ–‡ä»¶ä¸­æ•°æ®é¡µçš„åˆ†é…å’Œå›æ”¶ï¼Œä»¥åŠæ•°æ®é¡µä¸­æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚å…¶ä¸­ï¼Œæ•°æ®é¡µçš„åˆ†é…å’Œå›æ”¶é€šè¿‡ä½å›¾ï¼ˆBitmapï¼‰è¿™ä¸€æ•°æ®ç»“æ„å®ç°ï¼Œä½å›¾ä¸­æ¯ä¸ªæ¯”ç‰¹ï¼ˆBitï¼‰å¯¹åº”ä¸€ä¸ªæ•°æ®é¡µçš„åˆ†é…æƒ…å†µï¼Œç”¨äºæ ‡è®°è¯¥æ•°æ®é¡µæ˜¯å¦ç©ºé—²ï¼ˆ`0`è¡¨ç¤ºç©ºé—²ï¼Œ`1`è¡¨ç¤ºå·²åˆ†é…ï¼‰ã€‚å½“Buffer Pool Manageréœ€è¦å‘Disk Managerè¯·æ±‚æŸä¸ªæ•°æ®é¡µæ—¶ï¼ŒDisk Managerä¼šé€šè¿‡æŸç§æ˜ å°„å…³ç³»ï¼Œæ‰¾åˆ°è¯¥æ•°æ®é¡µåœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„ç‰©ç†ä½ç½®ï¼Œå°†å…¶è¯»å–åˆ°å†…å­˜ä¸­è¿”è¿˜ç»™Buffer Pool Managerã€‚è€ŒBuffer Pool Managerä¸»è¦è´Ÿè´£å°†ç£ç›˜ä¸­çš„æ•°æ®é¡µä»å†…å­˜ä¸­æ¥å›ç§»åŠ¨åˆ°ç£ç›˜ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬è®¾è®¡çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒé‚£äº›å ç”¨ç©ºé—´è¶…è¿‡è®¾å¤‡å…è®¸æœ€å¤§å†…å­˜ç©ºé—´çš„æ•°æ®åº“ã€‚

â€‹	Buffer Pool Managerä¸­çš„æ“ä½œå¯¹æ•°æ®åº“ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—æ˜¯é€æ˜çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ç³»ç»Ÿçš„å…¶å®ƒæ¨¡å—ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ•°æ®é¡µå”¯ä¸€æ ‡è¯†ç¬¦`page_id`å‘Buffer Pool Managerè¯·æ±‚å¯¹åº”çš„æ•°æ®é¡µã€‚ä½†å®é™…ä¸Šï¼Œè¿™äº›æ¨¡å—å¹¶ä¸çŸ¥é“è¯¥æ•°æ®é¡µæ˜¯å¦å·²ç»åœ¨å†…å­˜ä¸­è¿˜æ˜¯éœ€è¦ä»ç£ç›˜ä¸­è¯»å–ã€‚åŒæ ·åœ°ï¼ŒDisk Managerä¸­çš„æ•°æ®é¡µè¯»å†™æ“ä½œå¯¹Buffer Pool Manageræ¨¡å—ä¹Ÿæ˜¯é€æ˜çš„ï¼Œå³Buffer Pool Managerä½¿ç”¨é€»è¾‘é¡µå·`logical_page_id`å‘Disk Managerå‘èµ·æ•°æ®é¡µçš„è¯»å†™è¯·æ±‚ï¼Œä½†Buffer Pool Managerå¹¶ä¸çŸ¥é“è¯»å–çš„æ•°æ®é¡µå®é™…ä¸Šä½äºç£ç›˜æ–‡ä»¶ä¸­çš„å“ªä¸ªç‰©ç†é¡µï¼ˆå¯¹åº”é¡µå·`physical_page_id`ï¼‰ã€‚

#### Bitmap ï¼ˆå®ç°ä¸€ä¸ªç®€å•çš„ä½å›¾é¡µï¼‰

##### å®éªŒæ¦‚è¿°

ä½å›¾é¡µæ˜¯Disk Manageræ¨¡å—ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯å®ç°ç£ç›˜é¡µåˆ†é…ä¸å›æ”¶å·¥ä½œçš„å¿…è¦åŠŸèƒ½ç»„ä»¶ã€‚ä½å›¾é¡µä¸æ•°æ®é¡µä¸€æ ·ï¼Œå ç”¨`PAGE_SIZE`ï¼ˆ4KBï¼‰çš„ç©ºé—´ï¼Œæ ‡è®°ä¸€æ®µè¿ç»­é¡µçš„åˆ†é…æƒ…å†µã€‚

Bitmap Pageç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ç”¨äºåŠ é€ŸBitmapå†…éƒ¨æŸ¥æ‰¾çš„å…ƒä¿¡æ¯ï¼ˆBitmap Page Metaï¼‰ï¼Œå®ƒå¯ä»¥åŒ…å«å½“å‰å·²ç»åˆ†é…çš„é¡µçš„æ•°é‡ï¼ˆ`page_allocated_`ï¼‰ä»¥åŠä¸‹ä¸€ä¸ªç©ºé—²çš„æ•°æ®é¡µ(`next_free_page_`)ï¼Œå…ƒä¿¡æ¯æ‰€åŒ…å«çš„å†…å®¹å¯ä»¥ç”±åŒå­¦ä»¬æ ¹æ®å®é™…éœ€è¦è‡ªè¡Œå®šä¹‰ã€‚é™¤å»å…ƒä¿¡æ¯å¤–ï¼Œé¡µä¸­å‰©ä½™çš„éƒ¨åˆ†å°±æ˜¯Bitmapå­˜å‚¨çš„å…·ä½“æ•°æ®ï¼Œå…¶å¤§å°`BITMAP_CONTENT_SIZE`å¯ä»¥é€šè¿‡`PAGE_SIZE - BITMAP_PAGE_META_SIZE`æ¥è®¡ç®—ï¼Œè‡ªç„¶è€Œç„¶ï¼Œè¿™ä¸ªBitmap Pageèƒ½å¤Ÿæ”¯æŒæœ€å¤šçºªå½•`BITMAP_CONTENT_SIZE * 8`ä¸ªè¿ç»­é¡µçš„åˆ†é…æƒ…å†µã€‚

![img](æŠ¥å‘Šæ¨¡ç‰ˆ.assets/1648371054209-c0dd543c-8ca2-4be0-b0b9-e4a505b0c2de.png)

##### ä»£ç å®ç°

Bitmap Pageç›¸å…³çš„ä»£ç ä½äºsrc/include/page/bitmap_page.hå’Œsrc/page/bitmap_page.cppä¸­,	ä¸»è¦å®ç°äº†ä»¥ä¸‹å‡½æ•°

```cpp
å‡½æ•°æ¥å£ï¼š
BitmapPage::AllocatePage(&page_offset)ï¼šåˆ†é…ä¸€ä¸ªç©ºé—²é¡µï¼Œå¹¶é€šè¿‡page_offsetè¿”å›æ‰€åˆ†é…çš„ç©ºé—²é¡µä½äºè¯¥æ®µä¸­çš„ä¸‹æ ‡ï¼ˆä»0å¼€å§‹ï¼‰ï¼›
BitmapPage::DeAllocatePage(page_offset)ï¼šå›æ”¶å·²ç»è¢«åˆ†é…çš„é¡µï¼›
itmapPage::IsPageFree(page_offset)ï¼šåˆ¤æ–­ç»™å®šçš„é¡µæ˜¯å¦æ˜¯ç©ºé—²ï¼ˆæœªåˆ†é…ï¼‰çš„ã€‚
```

#### disk manager

##### å®éªŒæ¦‚è¿°

æŠŠä¸Šé¢è¯´çš„ä¸€ä¸ªä½å›¾é¡µåŠ ä¸€æ®µè¿ç»­çš„æ•°æ®é¡µçœ‹æˆæ•°æ®åº“æ–‡ä»¶ä¸­çš„ä¸€ä¸ªåˆ†åŒºï¼ˆExtentï¼‰ï¼Œå†é€šè¿‡ä¸€ä¸ªé¢å¤–çš„å…ƒä¿¡æ¯é¡µæ¥è®°å½•è¿™äº›åˆ†åŒºçš„ä¿¡æ¯ã€‚æ¥ä½¿ç£ç›˜æ–‡ä»¶èƒ½å¤Ÿç»´æŠ¤æ›´å¤šçš„æ•°æ®é¡µä¿¡æ¯ã€‚

##### ä»£ç å®ç°

```cpp
  // stream to write db file
  std::fstream db_io_;
  std::string file_name_;
  // with multiple buffer pool instances, need to protect file access
  std::recursive_mutex db_io_latch_;
  bool closed{false}; // ææ„æ—¶ä¼šåˆ¤æ–­å…³é—­fstreamæµ
  char meta_data_[PAGE_SIZE];// ä¿å­˜æ•´ä¸ªdisk managerçš„metaä¿¡æ¯
```

```cpp
void ReadPage(page_id_t logical_page_id, char *page_data);

  /**
   * Write data to specific page
   * Note: page_id = 0 is reserved for disk meta page
   */
  void WritePage(page_id_t logical_page_id, const char *page_data);

  /**
   * Get next free page from disk
   * @return logical page id of allocated page
   */
  page_id_t AllocatePage();
  
  /**
   * Free this page and reset bit map
   */
  void DeAllocatePage(page_id_t logical_page_id);

  /**
   * Return whether specific logical_page_id is free
   */
  bool IsPageFree(page_id_t logical_page_id);

  /**
   * Shut down the disk manager and close all the file resources.
   */
  void Close();

  /**
   * Get Meta Page
   * Note: Used only for debug
   */
  char *GetMetaData() {
    return meta_data_;
  }
  static constexpr size_t BITMAP_SIZE = BitmapPage<PAGE_SIZE>::GetMaxSupportedSize();
```

```mermaid
graph LR
  subgraph diskmanager
    ReadPage-->ReadPhysicalPage-->GetFileSize
    ReadPage-->mappageid
    AllocateExtent-->findextentphyid
    AllocatePage-->findextentphyid
    AllocatePage-->AllocateExtent
    WritePage-->WritePhysicalPage
    WritePage-->mappageid
    DeAllocatePage-->IsPageFree
  end
  subgraph bufferpool
  	allocatepage-->AllocatePage
    deallocatepage-->DeAllocatePage
    ispagefree-->IsPageFree
  end
```

#### LRU Replacerï¼ˆLRU æ›¿æ¢ç­–ç•¥ï¼‰

##### æ–‡æ¡£æ¦‚è¿°

Buffer Pool Replacerè´Ÿè´£è·Ÿè¸ªBuffer Poolä¸­æ•°æ®é¡µçš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶åœ¨Buffer Poolæ²¡æœ‰ç©ºé—²é¡µæ—¶å†³å®šæ›¿æ¢å“ªä¸€ä¸ªæ•°æ®é¡µã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ éœ€è¦å®ç°ä¸€ä¸ªåŸºäºLRUæ›¿æ¢ç®—æ³•çš„`LRUReplacer`ï¼Œ`LRUReplacer`ç±»åœ¨`src/include/buffer/lru_replacer.h`ä¸­è¢«å®šä¹‰ï¼Œå…¶æ‰©å±•äº†æŠ½è±¡ç±»`Replacer`ï¼ˆåœ¨`src/include/buffer/replacer.h`ä¸­è¢«å®šä¹‰ï¼‰ã€‚`LRUReplacer`çš„å¤§å°é»˜è®¤ä¸Buffer Poolçš„å¤§å°ç›¸åŒã€‚

LRUå°†è®¿é—®æ•°æ®çš„é¡ºåºæˆ–æ—¶é—´å’Œæ•°æ®æœ¬èº«ç»´æŠ¤åœ¨ä¸€ä¸ªå®¹å™¨å½“ä¸­ã€‚å½“è®¿é—®ä¸€ä¸ªæ•°æ®æ—¶ï¼š

1. è¯¥æ•°æ®ä¸åœ¨å®¹å™¨å½“ä¸­ï¼Œåˆ™è®¾ç½®è¯¥æ•°æ®çš„ä¼˜å…ˆçº§ä¸ºæœ€é«˜å¹¶æ”¾å…¥å®¹å™¨ä¸­ã€‚
2. è¯¥æ•°æ®åœ¨å®¹å™¨å½“ä¸­ï¼Œåˆ™æ›´æ–°è¯¥æ•°æ®çš„ä¼˜å…ˆçº§è‡³æœ€é«˜ã€‚

å½“æ•°æ®çš„æ€»é‡è¾¾åˆ°ä¸Šé™åï¼Œåˆ™ç§»é™¤å®¹å™¨ä¸­ä¼˜å…ˆçº§æœ€ä½çš„æ•°æ®ã€‚

lRUç­–ç•¥æœ€åˆé€‚çš„æ–¹æ¡ˆæ˜¯ï¼šåŒå‘é“¾è¡¨+å“ˆå¸Œï¼Œæ—¶é—´å¤æ‚åº¦O(1)

##### ä»£ç å®ç°

ç›¸å…³çš„ä»£ç ä½äº`src/buffer/lru_replacer.cpp`ä¸­ã€‚

```cpp
å‡½æ•°æ¥å£ï¼š
LRUReplacer::Victim(*frame_id)ï¼šæ›¿æ¢ï¼ˆå³åˆ é™¤ï¼‰ä¸æ‰€æœ‰è¢«è·Ÿè¸ªçš„é¡µç›¸æ¯”æœ€è¿‘æœ€å°‘è¢«è®¿é—®çš„é¡µï¼Œå°†å…¶é¡µå¸§å·ï¼ˆå³æ•°æ®é¡µåœ¨Buffer Poolçš„Pageæ•°ç»„ä¸­çš„ä¸‹æ ‡ï¼‰å­˜å‚¨åœ¨è¾“å‡ºå‚æ•°`frame_id`ä¸­è¾“å‡ºå¹¶è¿”å›`true`ï¼Œå¦‚æœå½“å‰æ²¡æœ‰å¯ä»¥æ›¿æ¢çš„å…ƒç´ åˆ™è¿”å›`false`ï¼›
LRUReplacer::Pin(frame_id)ï¼šå°†æ•°æ®é¡µå›ºå®šä½¿ä¹‹ä¸èƒ½è¢«`Replacer`æ›¿æ¢ï¼Œå³ä»`lru_list_`ä¸­ç§»é™¤è¯¥æ•°æ®é¡µå¯¹åº”çš„é¡µå¸§ã€‚`Pin`å‡½æ•°åº”å½“åœ¨ä¸€ä¸ªæ•°æ®é¡µè¢«Buffer Pool Managerå›ºå®šæ—¶è¢«è°ƒç”¨ï¼›
LRUReplacer::Unpin(frame_id)`ï¼šå°†æ•°æ®é¡µè§£é™¤å›ºå®šï¼Œæ”¾å…¥`lru_list_`ä¸­ï¼Œä½¿ä¹‹å¯ä»¥åœ¨å¿…è¦æ—¶è¢«`Replacer`æ›¿æ¢æ‰ã€‚`Unpin`å‡½æ•°åº”å½“åœ¨ä¸€ä¸ªæ•°æ®é¡µçš„å¼•ç”¨è®¡æ•°å˜ä¸º`0`æ—¶è¢«Buffer Pool Managerè°ƒç”¨ï¼Œä½¿é¡µå¸§å¯¹åº”çš„æ•°æ®é¡µèƒ½å¤Ÿåœ¨å¿…è¦æ—¶è¢«æ›¿æ¢ï¼›
  LRUReplacer::Size()ï¼šæ­¤æ–¹æ³•è¿”å›å½“å‰`LRUReplacer`ä¸­èƒ½å¤Ÿè¢«æ›¿æ¢çš„æ•°æ®é¡µçš„æ•°é‡ã€‚
  
ç»“æ„ï¼š
  private:
  deque<frame_id_t>lru_list;
  size_t size=0;
  unordered_map<frame_id_t,std::deque<frame_id_t>::iterator> replacer;
```

### RECORD MANAGER æ¨¡å—ï¼š

â€‹	Record Managerè´Ÿè´£ç®¡ç†æ•°æ®è¡¨ä¸­æ‰€æœ‰çš„è®°å½•ï¼Œå®ƒèƒ½å¤Ÿæ”¯æŒè®°å½•çš„æ’å…¥ã€åˆ é™¤ä¸æŸ¥æ‰¾æ“ä½œï¼Œå¹¶å¯¹å¤–æä¾›ç›¸åº”çš„æ¥å£ã€‚

ä¸è®°å½•ï¼ˆRecordï¼‰ç›¸å…³çš„æ¦‚å¿µæœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- åˆ—ï¼ˆ`Column`ï¼‰ï¼šåœ¨`src/include/record/column.h`ä¸­è¢«å®šä¹‰ï¼Œç”¨äºå®šä¹‰å’Œè¡¨ç¤ºæ•°æ®è¡¨ä¸­çš„æŸä¸€ä¸ªå­—æ®µï¼Œå³åŒ…å«äº†è¿™ä¸ªå­—æ®µçš„å­—æ®µåã€å­—æ®µç±»å‹ã€æ˜¯å¦å”¯ä¸€ç­‰ç­‰ï¼›
- æ¨¡å¼ï¼ˆ`Schema`ï¼‰ï¼šåœ¨`src/include/record/schema.h`ä¸­è¢«å®šä¹‰ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªæ•°æ®è¡¨æˆ–æ˜¯ä¸€ä¸ªç´¢å¼•çš„ç»“æ„ã€‚ä¸€ä¸ª`Schema`ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçš„`Column`æ„æˆï¼›
- åŸŸï¼ˆ`Field`ï¼‰ï¼šåœ¨`src/include/record/field.h`ä¸­è¢«å®šä¹‰ï¼Œå®ƒå¯¹åº”äºä¸€æ¡è®°å½•ä¸­æŸä¸€ä¸ªå­—æ®µçš„æ•°æ®ä¿¡æ¯ï¼Œå¦‚å­˜å‚¨æ•°æ®çš„æ•°æ®ç±»å‹ï¼Œæ˜¯å¦æ˜¯ç©ºï¼Œå­˜å‚¨æ•°æ®çš„å€¼ç­‰ç­‰ï¼›
- è¡Œï¼ˆ`Row`ï¼‰ï¼šåœ¨`src/include/record/row.h`ä¸­è¢«å®šä¹‰ï¼Œä¸å…ƒç»„çš„æ¦‚å¿µç­‰ä»·ï¼Œç”¨äºå­˜å‚¨è®°å½•æˆ–ç´¢å¼•é”®ï¼Œä¸€ä¸ª`Row`ç”±ä¸€ä¸ªæˆ–å¤šä¸ª`Field`æ„æˆã€‚

#### Record and Schema(è®°å½•ä¸æ¨¡å¼)

##### å®éªŒæ¦‚è¿°

â€‹	æœ‰å…³æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œçš„ä»»åŠ¡ã€‚ä¸ºäº†èƒ½å¤ŸæŒä¹…åŒ–å­˜å‚¨ä¸Šé¢æåˆ°çš„`Row`ã€`Field`ã€`Schema`å’Œ`Column`å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ç§èƒ½å¤Ÿå°†è¿™äº›å¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æµï¼ˆ`char*`ï¼‰çš„æ–¹æ³•ï¼Œä»¥å†™å…¥æ•°æ®é¡µä¸­ã€‚ä¸ä¹‹ç›¸å¯¹ï¼Œä¸ºäº†èƒ½å¤Ÿä»ç£ç›˜ä¸­æ¢å¤è¿™äº›å¯¹è±¡ï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦èƒ½å¤Ÿæä¾›ä¸€ç§ååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œä»æ•°æ®é¡µçš„`char*`ç±»å‹çš„å­—èŠ‚æµä¸­ååºåˆ—åŒ–å‡ºæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡ã€‚æ€»è€Œè¨€ä¹‹ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œå®é™…ä¸Šæ˜¯å°†æ•°æ®åº“ç³»ç»Ÿä¸­çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬è®°å½•ã€ç´¢å¼•ã€ç›®å½•ç­‰ï¼‰è¿›è¡Œå†…å¤–å­˜æ ¼å¼è½¬åŒ–çš„è¿‡ç¨‹ï¼Œå‰è€…å°†å†…å­˜ä¸­çš„é€»è¾‘æ•°æ®ï¼ˆå³å¯¹è±¡ï¼‰é€šè¿‡ä¸€å®šçš„æ–¹å¼ï¼Œè½¬æ¢æˆä¾¿äºåœ¨æ–‡ä»¶ä¸­å­˜å‚¨çš„ç‰©ç†æ•°æ®ï¼Œåè€…åˆ™ä»å­˜å‚¨çš„ç‰©ç†æ•°æ®ä¸­æ¢å¤å‡ºé€»è¾‘æ•°æ®ï¼Œä¸¤è€…çš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å®ç°æ•°æ®çš„æŒä¹…åŒ–ã€‚

â€‹	ä¸ºäº†ç¡®ä¿æ•°æ®èƒ½å¤Ÿæ­£ç¡®å­˜å‚¨ï¼Œ`Row`ã€`Schema`å’Œ`Column`å¯¹è±¡ä¸­éƒ½å¼•å…¥äº†é­”æ•°`MAGIC_NUM`ï¼Œå®ƒåœ¨åºåˆ—åŒ–æ—¶è¢«å†™å…¥åˆ°å­—èŠ‚æµçš„å¤´éƒ¨å¹¶åœ¨ååºåˆ—åŒ–ä¸­è¢«è¯»å‡ºä»¥éªŒè¯æˆ‘ä»¬åœ¨ååºåˆ—åŒ–æ—¶ç”Ÿæˆçš„å¯¹è±¡æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

â€‹	å®Œå–„`Row`ã€`Schema`å’Œ`Column`å¯¹è±¡å„è‡ªçš„`SerializeTo`ã€`DeserializeFrom`å’Œ`GetSerializedSize`æ–¹æ³•ï¼Œå…·ä½“ä»¥ä½•ç§æ–¹å¼è¿›è¡Œåºåˆ—åŒ–ï¼ˆå³éœ€è¦åºåˆ—åŒ–ç±»ä¸­çš„å“ªäº›æ•°æ®ï¼‰ç”±ä½ è‡ªè¡Œå†³å®šï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ä»£ç ä¸­åªä¼šéªŒè¯åºåˆ—åŒ–å‰åçš„å¯¹è±¡æ˜¯å¦åŒ¹é…ã€‚

â€‹	å…¶ä¸­ï¼Œ`SerializeTo`å’Œ`DeserializeFrom`å‡½æ•°çš„è¿”å›å€¼ä¸º`uint32_t`ç±»å‹ï¼Œå®ƒè¡¨ç¤ºåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­`buf`æŒ‡é’ˆå‘å‰æ¨è¿›äº†å¤šå°‘ä¸ªå­—èŠ‚ã€‚

â€‹	å¯¹äº`Row`ç±»å‹å¯¹è±¡çš„åºåˆ—åŒ–ï¼Œå¯ä»¥é€šè¿‡ä½å›¾çš„æ–¹å¼æ ‡è®°ä¸º`null`çš„`Field`(å³ *Null Bitmaps*)ï¼Œå¯¹äº`Row`ç±»å‹å¯¹è±¡çš„ååºåˆ—åŒ–ï¼Œåœ¨ååºåˆ—åŒ–æ¯ä¸€ä¸ª`Field`æ—¶ï¼Œéœ€è¦å°†è‡ªèº«çš„`heap_`ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°`Field`ç±»å‹çš„`Deserialize`å‡½æ•°ä¸­ï¼Œè¿™ä¹Ÿæ„å‘³ç€æ‰€æœ‰ååºåˆ—åŒ–å‡ºæ¥çš„`Field`çš„å†…å­˜éƒ½ç”±è¯¥`Row`å¯¹è±¡ç»´æŠ¤ã€‚å¯¹äº`Column`å’Œ`Schema`ç±»å‹å¯¹è±¡çš„ååºåˆ—åŒ–ï¼Œå°†ä½¿ç”¨`MemHeap`ç±»å‹çš„å¯¹è±¡`heap`æ¥åˆ†é…ç©ºé—´ï¼Œåˆ†é…åæ–°ç”Ÿæˆçš„å¯¹è±¡äºå‚æ•°`column`å’Œ`schema`ä¸­è¿”å›

##### ä¸ªäººç†è§£

æ€»ä½“æ€è·¯ï¼šé€šè¿‡å°†Columnã€Rowã€Schemaä¸­åŒ…å«çš„æ•°æ®è½¬æ¢æˆcharå­—ç¬¦ä¸²æµå­˜å‚¨è¿›è¡Œåºåˆ—åŒ–ï¼Œååºåˆ—åŒ–å°±æ˜¯ç›¸åº”çš„å°†åºåˆ—åŒ–çš„å†…å®¹æ¢å¤æˆåŸæ ·ã€‚åœ¨æœ¬æ¬¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ¡†æ¶æ‰€æä¾›çš„å®ï¼ˆæ„Ÿè°¢ycj dlï¼‰è¿›è¡Œç±»å‹è½¬æ¢ï¼Œä½†è¦æ³¨æ„çš„æ˜¯æ¯æ¬¡è¯»å…¥æ•°æ®ä¹‹åè¦å°†ç›¸åº”çš„bufæŒ‡é’ˆå¾€åæ¨ï¼Œå»è¯»å…¥ä¹‹åçš„å†…å®¹ã€‚

â€‹	éœ€è¦æ³¨æ„çš„æ˜¯å­˜å‚¨stringä¿¡æ¯çš„æ—¶å€™ï¼Œéœ€è¦é¢å¤–è®°å½•stringçš„é•¿åº¦(ä»¥åŠcharæ•°ç»„æœ«å°¾éœ€è¦åŠ '\0'ï¼Œå¦åˆ™å®¹æ˜“å‡ºç°ä¹±ç )

##### ä»£ç å®ç°

ç›¸å…³å®ç°ä»£ç åœ¨ï¼š`src/include/record/row.h`ã€ `src/record/row.cpp`ã€ `src/include/record/schema.h`ã€ `src/record/schema.cpp`ã€ `src/include/record/column.h`ã€ `src/record/column.cpp`çš„æ–‡ä»¶ä¸­

```cpp
å‡½æ•°æ¥å£ï¼š
Row::SerializeTo(*buf, *schema)ï¼›å°†Rowåºåˆ—åŒ–æˆcharå­—ç¬¦ä¸²æµä¿å­˜åœ¨buf
Row::DeserializeFrom(*buf, *schema)ï¼›å°†bufååºåˆ—åŒ–æˆRow
Row::GetSerializedSize(*schema)ï¼›å¾—åˆ°Rowåºåˆ—åŒ–ä¹‹åçš„é•¿åº¦
Column::SerializeTo(*buf)ï¼›å°†Columnåºåˆ—åŒ–æˆcharå­—ç¬¦ä¸²æµä¿å­˜åœ¨buf
Column::DeserializeFrom(*buf, *&column, *heap)ï¼›å°†bufååºåˆ—åŒ–æˆColumn
Column::GetSerializedSize()ï¼›å¾—åˆ°Columnåºåˆ—åŒ–ä¹‹åçš„é•¿åº¦
Schema::SerializeTo(*buf)ï¼›å°†Schemaåºåˆ—åŒ–æˆcharå­—ç¬¦ä¸²æµä¿å­˜åœ¨buf
Schema::DeserializeFrom(*buf, *&schema, *heap)ï¼›å°†bufååºåˆ—åŒ–æˆSchema
Schema::GetSerializedSize()ï¼›å¾—åˆ°Schemaåºåˆ—åŒ–ä¹‹åçš„é•¿åº¦
```

#### Table Heap(å †è¡¨)

##### å®éªŒæ¦‚è¿°

â€‹	å †è¡¨ï¼ˆ`TableHeap`ï¼Œç›¸å…³å®šä¹‰åœ¨`src/include/storage/table_heap.h`ï¼‰æ˜¯ä¸€ç§å°†è®°å½•ä»¥æ— åºå †çš„å½¢å¼è¿›è¡Œç»„ç»‡çš„æ•°æ®ç»“æ„ï¼Œä¸åŒçš„æ•°æ®é¡µï¼ˆ`TablePage`ï¼‰ä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥ã€‚å †è¡¨ä¸­çš„è®°å½•é€šè¿‡`RowId`è¿›è¡Œå®šä½ã€‚`RowId`è®°å½•äº†è¯¥è¡Œè®°å½•æ‰€åœ¨çš„`page_id`å’Œ`slot_num`ï¼Œå…¶ä¸­`slot_num`ç”¨äºå®šä½è®°å½•åœ¨è¿™ä¸ªæ•°æ®é¡µä¸­çš„ä¸‹æ ‡ä½ç½®ã€‚

â€‹	å †è¡¨ä¸­çš„æ¯ä¸ªæ•°æ®é¡µï¼ˆä¸è¯¾æœ¬ä¸­çš„`Slotted-page Structure`ç»™å‡ºçš„ç»“æ„åŸºæœ¬ä¸€è‡´ï¼Œè§ä¸‹å›¾ï¼Œèƒ½å¤Ÿæ”¯æŒå­˜å‚¨ä¸å®šé•¿çš„è®°å½•ï¼‰éƒ½ç”±è¡¨å¤´ï¼ˆTable Page Headerï¼‰ã€ç©ºé—²ç©ºé—´ï¼ˆFree Spaceï¼‰å’Œå·²ç»æ’å…¥çš„æ•°æ®ï¼ˆInserted Tuplesï¼‰ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸ä¹‹ç›¸å…³çš„ä»£ç ä½äº`src/include/page/table_page.h`ä¸­ï¼Œè¡¨å¤´åœ¨é¡µä¸­ä»å·¦å¾€å³æ‰©å±•ï¼Œè®°å½•äº†`PrevPageId`ã€`NextPageId`ã€`FreeSpacePointer`ä»¥åŠæ¯æ¡è®°å½•åœ¨`TablePage`ä¸­çš„åç§»å’Œé•¿åº¦ï¼›æ’å…¥çš„è®°å½•åœ¨é¡µä¸­ä»å³å‘å·¦æ‰©å±•ï¼Œæ¯æ¬¡æ’å…¥è®°å½•æ—¶ä¼šå°†`FreeSpacePointer`çš„ä½ç½®å‘å·¦ç§»åŠ¨ã€‚

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/1649165584868-b8768a94-7287-4ffa-8283-126368851db6.png" alt="image.png" style="zoom:50%;" />

â€‹	å½“å‘å †è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œä¸€ç§ç®€å•çš„åšæ³•æ˜¯ï¼Œæ²¿ç€`TablePage`æ„æˆçš„é“¾è¡¨ä¾æ¬¡æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½å¤Ÿå®¹çº³è¯¥è®°å½•çš„`TablePage`ï¼ˆ*First Fit* ç­–ç•¥ï¼‰ã€‚å½“éœ€è¦ä»å †è¡¨ä¸­åˆ é™¤æŒ‡å®š`RowId`å¯¹åº”çš„è®°å½•æ—¶ï¼Œæ¡†æ¶ä¸­æä¾›äº†ä¸€ç§é€»è¾‘åˆ é™¤çš„æ–¹æ¡ˆï¼Œå³é€šè¿‡æ‰“ä¸ŠDelete Maskæ¥æ ‡è®°è®°å½•è¢«åˆ é™¤ï¼Œåœ¨ä¹‹åæŸä¸ªæ—¶é—´æ®µå†ä»ç‰©ç†æ„ä¹‰ä¸ŠçœŸæ­£åˆ é™¤è¯¥è®°å½•ï¼ˆæœ¬èŠ‚ä¸­éœ€è¦å®Œæˆçš„ä»»åŠ¡ä¹‹ä¸€ï¼‰ã€‚å¯¹äºæ›´æ–°æ“ä½œï¼Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µè¿›è¡Œè€ƒè™‘ï¼Œä¸€ç§æ˜¯`TablePage`èƒ½å¤Ÿå®¹çº³ä¸‹æ›´æ–°åçš„æ•°æ®ï¼Œå¦ä¸€ç§åˆ™æ˜¯`TablePage`ä¸èƒ½å¤Ÿå®¹çº³ä¸‹æ›´æ–°åçš„æ•°æ®ï¼Œå‰è€…ç›´æ¥åœ¨æ•°æ®é¡µä¸­è¿›è¡Œæ›´æ–°å³å¯ï¼Œåè€…çš„å®ç°æ–¹å¼ç•™ç»™åŒå­¦ä»¬è‡ªè¡Œæ€è€ƒã€‚æ­¤å¤–ï¼Œåœ¨å †è¡¨ä¸­è¿˜éœ€è¦å®ç°è¿­ä»£å™¨`TableIterator`ä»¥ä¾¿ä¸Šå±‚æ¨¡å—éå†å †è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚

##### ä¸ªäººç†è§£

æ€»ä½“æ€è·¯ï¼šé€šè¿‡table_heapå®ç°å¯¹tupleçš„Insertã€Deleteã€Updateç­‰æ“ä½œã€‚å› ä¸ºå·²ç»å®ç°äº†pageä¸­å¯¹tupleçš„ç›¸åº”çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæœ‰å…³çš„æ“ä½œåªéœ€è¦é€šè¿‡ridæ‰¾åˆ°ç›¸åº”çš„/åˆé€‚çš„pageï¼ˆåˆ©ç”¨buffer_pool_managerå¯¹å…¶fetchï¼Œä¹‹åä½¿ç”¨å®Œæ¯•ä¹‹åéœ€è¦è°ƒç”¨Unpingï¼‰ï¼Œå†è°ƒç”¨pageä¸­çš„æ“ä½œå‡½æ•°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯Updateæ“ä½œï¼šåœ¨å‡ºç°æ²¡æ‰¾åˆ°ç›¸åº”tupleçš„æ—¶å€™è¿”å›falseï¼›å¦‚æœæ‰¾åˆ°äº†tupleä½†æ˜¯å½“å‰pageå·²ç»æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å¯ä»¥å­˜æ”¾æ›´æ–°çš„tupleçš„æ—¶å€™ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯åˆ é™¤å½“å‰å·²å­˜åœ¨çš„old tupleï¼ˆmarkdelteä¹‹åapplydeleteï¼‰ï¼Œä¹‹åæ’å…¥æ–°çš„tupleã€‚

##### ä»£ç å®ç°

ç›¸å…³ä»£ç åœ¨`src/include/storage/table_heap.h`ã€ `src/storage/table_heap.cpp`ã€ `test/record/tuple_test.cpp`ã€`src/include/storage/table_iterator.h`	ã€`src/storage/table_iterator.cpp`ä¸­

```cpp
å‡½æ•°æ¥å£ï¼š
TableHeap::InsertTuple(&row,*txn)ï¼šå‘å †è¡¨ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œæ’å…¥è®°å½•åç”ŸæˆRowIdéœ€è¦é€šè¿‡rowå¯¹è±¡è¿”å›ï¼›
TableHeap::UpdateTuple(&new_row, &rid, *txn)ï¼šå°†RowIdä¸ºridçš„è®°å½•old_rowæ›¿æ¢æˆæ–°çš„è®°å½•new_rowï¼Œå¹¶å°†new_rowçš„RowIdé€šè¿‡new_row.rid_è¿”å›ï¼›
TableHeap::ApplyDelete(&rid, *txn)ï¼šä»ç‰©ç†æ„ä¹‰ä¸Šåˆ é™¤è¿™æ¡è®°å½•ï¼›
TableHeap::GetTuple(*row, *txn)ï¼šè·å–RowIdä¸ºrow->rid_çš„è®°å½•ï¼›
TableHeap::FreeHeap()ï¼šé”€æ¯æ•´ä¸ªTableHeapå¹¶é‡Šæ”¾è¿™äº›æ•°æ®é¡µï¼›
TableHeap::Begin()ï¼šè·å–å †è¡¨çš„é¦–è¿­ä»£å™¨ï¼›
TableHeap::End()ï¼šè·å–å †è¡¨çš„å°¾è¿­ä»£å™¨;

è¿­ä»£å™¨éƒ¨åˆ†å‡½æ•°æ¥å£ï¼š
TableIterator::operator++():ç§»åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ï¼Œé€šè¿‡++iterè°ƒç”¨ï¼›
TableIterator::operator++(int):ç§»åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•ï¼Œé€šè¿‡iter++è°ƒç”¨;
```

### INDEX MANAGER æ¨¡å—ï¼š

â€‹	Index Manager è´Ÿè´£æ•°æ®è¡¨ç´¢å¼•çš„å®ç°å’Œç®¡ç†ï¼ŒåŒ…æ‹¬ï¼šç´¢å¼•çš„åˆ›å»ºå’Œåˆ é™¤ï¼Œç´¢å¼•é”®çš„ç­‰å€¼æŸ¥æ‰¾ï¼Œç´¢å¼•é”®çš„èŒƒå›´æŸ¥æ‰¾ï¼ˆè¿”å›å¯¹åº”çš„è¿­ä»£å™¨ï¼‰ï¼Œä»¥åŠæ’å…¥å’Œåˆ é™¤é”®å€¼ç­‰æ“ä½œï¼Œå¹¶å¯¹å¤–æä¾›ç›¸åº”çš„æ¥å£ã€‚

â€‹	åœ¨ä¸Šä¸€ä¸ªå®éªŒä¸­ï¼ŒåŒå­¦ä»¬åº”è¯¥èƒ½å¤Ÿå‘ç°ï¼Œé€šè¿‡éå†å †è¡¨çš„æ–¹å¼æ¥æŸ¥æ‰¾ä¸€æ¡è®°å½•æ˜¯ååˆ†ä½æ•ˆçš„ã€‚ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°æŸæ¡è®°å½•è€Œæ— éœ€æœç´¢æ•°æ®è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸Šä¸€ä¸ªå®éªŒçš„åŸºç¡€ä¸Šå®ç°ä¸€ä¸ªç´¢å¼•ï¼Œè¿™èƒ½å¤Ÿä¸ºå¿«é€ŸéšæœºæŸ¥æ‰¾å’Œé«˜æ•ˆè®¿é—®æœ‰åºè®°å½•æä¾›åŸºç¡€ã€‚ç´¢å¼•æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œå¦‚B+æ ‘ç´¢å¼•ï¼ŒHashç´¢å¼•ç­‰ç­‰ã€‚åœ¨æœ¬å®éªŒä¸­ï¼Œéœ€å®ç°ä¸€ä¸ªåŸºäºç£ç›˜çš„B+æ ‘åŠ¨æ€ç´¢å¼•ç»“æ„ã€‚

#### BPlusTreePage

##### å®éªŒæ¦‚è¿°

`BPlusTreePage`æ˜¯`BPlusTreeInternalPage`å’Œ`BPlusTreeLeafPage`ç±»çš„å…¬å…±çˆ¶ç±»ï¼Œå®ƒåŒ…å«äº†ä¸­é—´ç»“ç‚¹å’Œå¶å­ç»“ç‚¹å…±åŒéœ€è¦çš„æ•°æ®ï¼š

- `page_type_`: æ ‡è®°æ•°æ®é¡µæ˜¯ä¸­é—´ç»“ç‚¹è¿˜æ˜¯å¶å­ç»“ç‚¹ï¼›
- `lsn_`: æ•°æ®é¡µçš„æ—¥å¿—åºåˆ—å·ï¼Œç›®å‰ä¸ä¼šç”¨åˆ°ï¼Œå¦‚æœä¹‹åæ„Ÿå…´è¶£åšCrash Recoveryç›¸å…³çš„å†…å®¹éœ€è¦ç”¨åˆ°ï¼›
- `size_`: å½“å‰ç»“ç‚¹ä¸­å­˜å‚¨Key-Valueé”®å€¼å¯¹çš„æ•°é‡ï¼›
- `max_size_`: å½“å‰ç»“ç‚¹æœ€å¤šèƒ½å¤Ÿå®¹çº³Key-Valueé”®å€¼å¯¹çš„æ•°é‡ï¼›
- `parent_page_id_`: çˆ¶ç»“ç‚¹å¯¹åº”æ•°æ®é¡µçš„`page_id`;
- `page_id_`: å½“å‰ç»“ç‚¹å¯¹åº”æ•°æ®é¡µçš„`page_id`ã€‚

##### ä¸ªäººç†è§£

ä¸»è¦å°±æ˜¯å†…éƒ¨è°ƒç”¨ç»“æ„ä½“privateçš„æ•°æ®ã€‚

##### ä»£ç å®ç°

ä»£ç å®ç°åœ¨

- `src/include/storage/page/b_plus_tree_page.h`
- `src/page/b_plus_tree_page.cpp`

```cpp 
å‡½æ•°æ¥å£:
  bool IsLeafPage() const;
  bool IsRootPage() const;
  void SetPageType(IndexPageType page_type);
  int GetSize() const;
  void SetSize(int size);
  void IncreaseSize(int amount);
  int GetMaxSize() const;
  void SetMaxSize(int max_size);
  int GetMinSize() const;
  page_id_t GetParentPageId() const;
  void SetParentPageId(page_id_t parent_page_id);
  page_id_t GetPageId() const;
  void SetPageId(page_id_t page_id);
  void SetLSN(lsn_t lsn = INVALID_LSN);
```



####  BPlusTreeInternalPage

##### å®éªŒæ¦‚è¿°

â€‹	ä¸­é—´ç»“ç‚¹`BPlusTreeInternalPage`ä¸å­˜å‚¨å®é™…çš„æ•°æ®ï¼Œå®ƒåªæŒ‰ç…§é¡ºåºå­˜å‚¨![img](https://cdn.nlark.com/yuque/__latex/4760e2f007e23d820825ba241c47ce3b.svg)ä¸ªé”®å’Œ![img](https://cdn.nlark.com/yuque/__latex/d6f147b9f168e0b5fbec1db2ccaa315b.svg)ä¸ªæŒ‡é’ˆï¼ˆè¿™äº›æŒ‡é’ˆè®°å½•çš„æ˜¯å­ç»“ç‚¹çš„`page_id`ï¼‰ã€‚ç”±äºé”®å’ŒæŒ‡é’ˆçš„æ•°é‡ä¸ç›¸ç­‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†ç¬¬ä¸€ä¸ªé”®è®¾ç½®ä¸ºINVALIDï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé¡ºåºæŸ¥æ‰¾æ—¶éœ€è¦ä»ç¬¬äºŒä¸ªé”®å¼€å§‹æŸ¥æ‰¾ã€‚åœ¨ä»»ä½•æ—¶å€™ï¼Œæ¯ä¸ªä¸­é—´ç»“ç‚¹è‡³å°‘æ˜¯åŠæ»¡çš„ï¼ˆHalf Fullï¼‰ã€‚å½“åˆ é™¤æ“ä½œå¯¼è‡´æŸä¸ªç»“ç‚¹ä¸æ»¡è¶³åŠæ»¡çš„æ¡ä»¶ï¼Œéœ€è¦é€šè¿‡åˆå¹¶ï¼ˆMergeï¼‰ç›¸é‚»ä¸¤ä¸ªç»“ç‚¹æˆ–æ˜¯ä»å¦ä¸€ä¸ªç»“ç‚¹ä¸­å€Ÿç”¨ï¼ˆç§»åŠ¨ï¼‰ä¸€ä¸ªå…ƒç´ åˆ°è¯¥ç»“ç‚¹ä¸­ï¼ˆRedistribute)æ¥ä½¿è¯¥ç»“ç‚¹æ»¡è¶³åŠæ»¡çš„æ¡ä»¶ã€‚å½“æ’å…¥æ“ä½œå¯¼è‡´æŸä¸ªç»“ç‚¹æº¢å‡ºæ—¶ï¼Œéœ€è¦å°†è¿™ä¸ªç»“ç‚¹åˆ†è£‚æˆä¸ºä¸¤ä¸ªç»“ç‚¹ã€‚

â€‹	Note: ä¸ºäº†ä¾¿äºç†è§£å’Œè®¾è®¡ï¼Œæˆ‘ä»¬å°†é”®å’ŒæŒ‡é’ˆä»¥`pair`çš„å½¢å¼é¡ºåºå­˜å‚¨ï¼Œä½†ç”±äºé”®å’ŒæŒ‡é’ˆçš„æ•°é‡ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬ä¸å¾—å·²ç‰ºç‰²ä¸€ä¸ªé”®çš„ç©ºé—´ï¼Œå°†å…¶æ ‡è®°ä¸ºINVALIDã€‚å¯¹äºB+æ ‘çš„æ¯ä¸€ä¸ªä¸­é—´ç»“ç‚¹ï¼Œæˆ‘ä»¬éƒ½ä»˜å‡ºäº†ä¸€ä¸ªé”®çš„ç©ºé—´ä»£ä»·ã€‚å®é™…ä¸Šæœ‰ä¸€ç§æ›´ä¸ºç²¾ç»†çš„è®¾è®¡é€‰æ‹©ï¼šå®šä¹‰ä¸€ä¸ªå¤§å°ä¸º![img](https://cdn.nlark.com/yuque/__latex/4760e2f007e23d820825ba241c47ce3b.svg)çš„æ•°ç»„è¿ç»­å­˜æ”¾é”®ï¼Œç„¶åå®šä¹‰ä¸€ä¸ªå¤§å°ä¸º![img](https://cdn.nlark.com/yuque/__latex/d6f147b9f168e0b5fbec1db2ccaa315b.svg)çš„æ•°ç»„è¿ç»­å­˜æ”¾æŒ‡é’ˆï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„åœ¨äºï¼Œä¸€æ˜¯æ²¡æœ‰ç©ºé—´ä¸Šçš„æµªè´¹ï¼ŒäºŒæ˜¯åœ¨é”®å€¼æŸ¥æ‰¾æ—¶CPUç¼“å­˜çš„å‘½ä¸­ç‡è¾ƒé«˜ï¼ˆå±€éƒ¨æ€§åŸç†)

#### BPlusTreeLeafPage

##### å®éªŒæ¦‚è¿°

å¶ç»“ç‚¹`BPlusTreeLeafPage`å­˜å‚¨å®é™…çš„æ•°æ®ï¼Œå®ƒæŒ‰ç…§é¡ºåºå­˜å‚¨![img](https://cdn.nlark.com/yuque/__latex/4760e2f007e23d820825ba241c47ce3b.svg)ä¸ªé”®å’Œ![img](https://cdn.nlark.com/yuque/__latex/4760e2f007e23d820825ba241c47ce3b.svg)ä¸ªå€¼ï¼Œå…¶ä¸­é”®ç”±ä¸€ä¸ªæˆ–å¤šä¸ª`Field`åºåˆ—åŒ–å¾—åˆ°ï¼ˆå‚è€ƒ#3.2.4)ï¼Œåœ¨`BPlusTreeLeafPage`ç±»ä¸­ç”¨æ¨¡æ¿å‚æ•°`KeyType`è¡¨ç¤ºï¼›å€¼å®é™…ä¸Šå­˜å‚¨çš„æ˜¯`RowId`çš„å€¼ï¼Œå®ƒåœ¨`BPlusTreeLeafPage`ç±»ä¸­ç”¨æ¨¡æ¿å‚æ•°`ValueType`è¡¨ç¤ºã€‚å¶ç»“ç‚¹å’Œä¸­é—´ç»“ç‚¹ä¸€æ ·éµå¾ªç€é”®å€¼å¯¹æ•°é‡çš„çº¦æŸï¼ŒåŒæ ·ä¹Ÿéœ€è¦å®Œæˆå¯¹åº”çš„åˆå¹¶ã€å€Ÿç”¨å’Œåˆ†è£‚æ“ä½œã€‚

éœ€è¦åœ¨`src/include/storage/page/b_plus_tree_leaf_page.h`å’Œ`src/page/b_plus_tree_leaf_page.cpp`ä¸­å®ç°`BPlusTreeLeafPage`ç±»ã€‚

##### ä¸ªäººç†è§£

åœ¨æ¯”è¾ƒKeyçš„æ—¶å€™ï¼Œæˆ‘ä¸€å¼€å§‹é‡‡å–çš„æ˜¯éå†ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œæ”¹ä¸ºäºŒåˆ†å¯ä»¥å¤§å¤§ä¼˜åŒ–æ•ˆç‡ï¼Œæ—¶é—´å¤æ‚åº¦é™ä½ä¸ºO(N)

##### ä»£ç å®ç°

å‡½æ•°å®ç°åœ¨

- `src/include/storage/page/b_plus_tree_internal_page.h`
- `src/storage/page/b_plus_tree_internal_page.cpp`

```cpp
å‡½æ•°æ¥å£ï¼š
	KeyType KeyAt(int index) const;
  void SetKeyAt(int index, const KeyType &key);
  void SetValueAt(int index, const ValueType &value);
  int ValueIndex(const ValueType &value) const;
  ValueType ValueAt(int index) const;
  ValueType Lookup(const KeyType &key, const KeyComparator &comparator) const;
  void PopulateNewRoot(const ValueType &old_value, const KeyType &new_key, const ValueType &new_value);
  int InsertNodeAfter(const ValueType &old_value, const KeyType &new_key, const ValueType &new_value);
  void Remove(int index);
  ValueType RemoveAndReturnOnlyChild();
  // Split and Merge utility methods
  void MoveAllTo(BPlusTreeInternalPage *recipient, const KeyType &middle_key, BufferPoolManager *buffer_pool_manager);
  void MoveHalfTo(BPlusTreeInternalPage *recipient, BufferPoolManager *buffer_pool_manager);
  void MoveFirstToEndOf(BPlusTreeInternalPage *recipient, const KeyType &middle_key,BufferPoolManager *buffer_pool_manager);
  void MoveLastToFrontOf(BPlusTreeInternalPage *recipient, const KeyType &middle_key,BufferPoolManager *buffer_pool_manager);
private:
  void CopyNFrom(MappingType *items, int size, BufferPoolManager *buffer_pool_manager);
  void CopyLastFrom(const MappingType &pair, BufferPoolManager *buffer_pool_manager);
  void CopyFirstFrom(const MappingType &pair, BufferPoolManager *buffer_pool_manager);

```

#### KeyTypeã€ValueType & KeyComparator

åœ¨B+æ ‘çš„æ•°æ®é¡µä»¥åŠç´¢å¼•ä¸­ï¼Œè€ƒè™‘åˆ°ç´¢å¼•é”®ç±»å‹å¯èƒ½ä¼šä¸åŒï¼ˆå¯¹ä¸åŒé•¿åº¦çš„ç´¢å¼•é”®ä½¿ç”¨ä¸åŒçš„ç´¢å¼•é”®ç±»å‹ï¼Œå¦‚ä¸ºæœ€å¤§é•¿åº¦ä¸è¶…è¿‡32å­—èŠ‚çš„ç´¢å¼•é”®ä½¿ç”¨`GenericKey<32>`ï¼ˆåœ¨`src/include/index/generic_key.h`ä¸­å®šä¹‰ï¼‰ï¼Œä¸ºæœ€å¤§é•¿åº¦ä¸è¶…è¿‡64å­—èŠ‚çš„ç´¢å¼•é”®ä½¿ç”¨`GenericKey<64>`ç­‰ç­‰ï¼‰ã€å€¼ç±»å‹ä¹Ÿå¯èƒ½ä¸åŒï¼ˆå¶ç»“ç‚¹å­˜å‚¨`RowId`ï¼Œè€Œéå¶ç»“ç‚¹å­˜å‚¨`page_id`ï¼‰ã€å¯¹åº”çš„æ¯”è¾ƒæ–¹å¼ä¹Ÿæœ‰å¯èƒ½ä¸åŒï¼ˆå¦‚
#### index iterator

##### æ•°æ®ç»“æ„

```cpp
  BPlusTreeLeafPage<KeyType, ValueType, KeyComparator> *leaf;
  int idx;// åˆ¤æ–­æ˜¯å¦ç›¸ç­‰
  BufferPoolManager *bpm_;
  Page *page_;
```

##### æ¥å£

```cpp
 public:
  explicit IndexIterator();
  explicit IndexIterator(Page *page, int index, BufferPoolManager *bpm);
  ~IndexIterator();
  /** return whether it is the end of leaf node list*/
  bool isEnd();
  /** Return the key/value pair this iterator is currently pointing at. */
  const MappingType &operator*() const;
  /** Move to the next key/value pair.*/
  IndexIterator &operator++();
  /** Return whether two iterators are equal */
  bool operator==(const IndexIterator &itr) const;
  /** Return whether two iterators are not equal. */
  bool operator!=(const IndexIterator &itr) const;
```

```mermaid
graph LR
  subgraph bufferpool
  	FetchPage
  	UnpinPage
  end
  subgraph IndexIterator
    ReadPage-->IndexIteratoræ„é€ å‡½æ•°
    op++ --> FetchPage
    op++ --> UnpinPage
  end
  subgraph BPLUSTREE
  	Begin-->IndexIteratoræ„é€ å‡½æ•°
    End-->IndexIteratoræ„é€ å‡½æ•°
  end

```




### CATALOG MANAGER æ¨¡å—ï¼š

â€‹	Catalog Manager è´Ÿè´£ç®¡ç†å’Œç»´æŠ¤æ•°æ®åº“çš„æ‰€æœ‰æ¨¡å¼ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„å®šä¹‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„åç§°ã€è¡¨ä¸­å­—æ®µï¼ˆåˆ—ï¼‰æ•°ã€ä¸»é”®ã€å®šä¹‰åœ¨è¯¥è¡¨ä¸Šçš„ç´¢å¼•ã€‚
- è¡¨ä¸­æ¯ä¸ªå­—æ®µçš„å®šä¹‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å­—æ®µç±»å‹ã€æ˜¯å¦å”¯ä¸€ç­‰ã€‚
- æ•°æ®åº“ä¸­æ‰€æœ‰ç´¢å¼•çš„å®šä¹‰ï¼ŒåŒ…æ‹¬æ‰€å±è¡¨ã€ç´¢å¼•å»ºç«‹åœ¨é‚£ä¸ªå­—æ®µä¸Šç­‰ã€‚

è¿™äº›æ¨¡å¼ä¿¡æ¯åœ¨è¢«åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤åè¿˜åº”è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“æ–‡ä»¶ä¸­ã€‚æ­¤å¤–ï¼ŒCatalog Managerè¿˜éœ€è¦ä¸ºä¸Šå±‚çš„æ‰§è¡Œå™¨Executoræä¾›å…¬å…±æ¥å£ä»¥ä¾›æ‰§è¡Œå™¨è·å–ç›®å½•ä¿¡æ¯å¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚

### SQL EXECUTOR æ¨¡å—ï¼š

Executorï¼ˆæ‰§è¡Œå™¨ï¼‰çš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®è§£é‡Šå™¨ï¼ˆParserï¼‰ç”Ÿæˆçš„è¯­æ³•æ ‘ï¼Œé€šè¿‡Catalog Manager æä¾›çš„ä¿¡æ¯ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œå¹¶è°ƒç”¨ Record Managerã€Index Manager å’Œ Catalog Manager æä¾›çš„ç›¸åº”æ¥å£è¿›è¡Œæ‰§è¡Œï¼Œæœ€åé€šè¿‡æ‰§è¡Œä¸Šä¸‹æ–‡`ExecuteContext`å°†æ‰§è¡Œç»“æœè¿”å›ç»™ä¸Šå±‚æ¨¡å—ã€‚

#### å®éªŒæ¦‚è¿°

**è¯­æ³•æ ‘æ•°æ®ç»“æ„**ï¼šä»¥ä¸‹æ˜¯è¯­æ³•æ ‘ï¼ˆç»“ç‚¹ï¼‰çš„æ•°æ®ç»“æ„å®šä¹‰ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦`id_`ï¼Œå”¯ä¸€æ ‡è¯†ç¬¦åœ¨è°ƒç”¨`CreateSyntaxNode`å‡½æ•°æ—¶ç”Ÿæˆï¼ˆæ¡†æ¶ä¸­å·²ç»ç»™å‡ºå®ç°ï¼‰ã€‚`type_`è¡¨ç¤ºè¯­æ³•æ ‘ç»“ç‚¹çš„ç±»å‹ï¼Œ`line_no_`å’Œ`col_no_`è¡¨ç¤ºè¯¥è¯­æ³•æ ‘ç»“ç‚¹å¯¹åº”çš„æ˜¯SQLè¯­å¥çš„ç¬¬å‡ è¡Œç¬¬å‡ åˆ—ï¼Œ`child_`å’Œ`next_`åˆ†åˆ«è¡¨ç¤ºè¯¥ç»“ç‚¹çš„å­ç»“ç‚¹å’Œå…„å¼Ÿç»“ç‚¹ï¼Œ`val_`ç”¨ä½œä¸€äº›é¢å¤–ä¿¡æ¯çš„å­˜å‚¨ï¼ˆå¦‚åœ¨`kNodeString`ç±»å‹çš„ç»“ç‚¹ä¸­ï¼Œ`val_`å°†ç”¨äºå­˜å‚¨è¯¥å­—ç¬¦ä¸²çš„å­—é¢é‡ï¼‰ã€‚

```cpp
/**
 * Syntax node definition used in abstract syntax tree.
 */
struct SyntaxNode {
  int id_;    /** node id for allocated syntax node, used for debug */
  SyntaxNodeType type_; /** syntax node type */
  int line_no_; /** line number of this syntax node appears in sql */
  int col_no_;  /** column number of this syntax node appears in sql */
  struct SyntaxNode *child_;  /** children of this syntax node */
  struct SyntaxNode *next_;   /** siblings of this syntax node, linked by a single linked list */
  char *val_; /** attribute value of this syntax node, use deep copy */
};
typedef struct SyntaxNode *pSyntaxNode;
```

#### ä¸ªäººç†è§£

è¯¥æ¨¡å—ä¸»è¦çš„å·¥ä½œåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š

- æ‰’è¯­æ³•æ ‘è·å–ä¿¡æ¯
- è°ƒç”¨ä¸Šå±‚æ¥å£
- å‡ºç°bugææœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„é—®é¢˜ï¼Œéœ€è¦åŠæ—¶ä¿®å¤ä¹‹å‰çš„bug

#### ä»£ç å®ç°

##### æ•°æ®ç»“æ„

```cpp
  [[maybe_unused]] std::unordered_map<std::string, DBStorageEngine *> dbs_; /** all opened databases */
  [[maybe_unused]] std::string current_db_;        
//  DBStorageEngineçš„æ•°æ®ç»“æ„ä¸º 
  DiskManager *disk_mgr_;
  BufferPoolManager *bpm_;
  CatalogManager *catalog_mgr_;
  std::string db_file_name_;
  bool init_;
```

##### æ¥å£

 ```cpp
   dberr_t Execute(pSyntaxNode ast, ExecuteContext *context);
 //å†…éƒ¨å‡½æ•°å‚çœ‹å†…éƒ¨å®ç°ã€‚
 ExecuteEngine::ExecuteEngine() ;//åœ¨æ„é€ å‡½æ•°ä¸­æå–ä¿¡æ¯ç”¨æ¥æŒä¹…åŒ–ã€‚
 ```
##### å›¾å½¢åŒ–è¾“å‡º

é€šè¿‡printfæ— æ³•ç›´æ¥è¾“å‡ºå®Œå¤‡çš„è¡¨æ ¼ï¼Œäºæ˜¯å°è£…äº†è¾“å‡ºè¡¨æ ¼çš„å‡½æ•°ï¼Œæ–¹ä¾¿ä¹‹åæ‰§è¡Œçš„æ—¶å€™è°ƒç”¨ã€‚å¦‚ä¸‹

```cpp
// ç”»è¡Œçº¿
void ExecuteEngine::Draw_line(vector<int> max, int columns)ï¼›
}

//ç”»è¡¨æ ¼
void ExecuteEngine::Draw_Data(vector<int> max, vector<vector<string>> str, vector<string> head, int columns, int row)ï¼›
```

##### Database

create database

```cpp
dberr_t ExecuteEngine::ExecuteCreateDatabase(pSyntaxNode ast, ExecuteContext *context)ï¼›
```

##### Table

```cpp
create table t1(a int, b char(20) unique, c float, primary key(a, c));
```

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/1653735077288-a5d19bf5-7c96-4a49-a381-655401e46cc7.svg" alt="img" style="zoom:150%;" />

```cpp
éœ€è¦æ³¨æ„çš„æ˜¯åœ¨åˆ›å»ºè¡¨æ—¶ï¼Œä¸ä»…è¦å¯¹primary keyå»ºç«‹ç´¢å¼•ï¼Œè¿˜è¦å¯¹uniqueçš„å±æ€§å»ºç«‹ç´¢å¼•
åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™è‡ªåŠ¨ç”Ÿæˆindex
- uniqueä¼šç”Ÿæˆå•ä¸ªç´¢å¼•
- primarykeyä¹Ÿä¼šç”Ÿæˆç›¸åº”çš„ç´¢å¼•
```

```cpp
dberr_t ExecuteEngine::ExecuteCreateTable(pSyntaxNode ast, ExecuteContext *context)ï¼›
```

##### Index

```cpp
create index idx01 on account(name)
```

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/1653837906598-0d3999c4-a775-4d05-8686-e15b29b88b30.svg" alt="img" style="zoom: 33%;" />

```cpp
dberr_t ExecuteEngine::ExecuteShowIndexes(pSyntaxNode ast, ExecuteContext *context)ï¼›
```

##### Conditionè·å–

åœ¨selectã€Updateã€Dropçš„æ‰§è¡Œä¸­éƒ½éœ€è¦å¯¹æ¡ä»¶è¿›è¡Œæå–ï¼Œä¸»è¦å°±æ˜¯æ‰’è¯­æ³•æ ‘ï¼Œè·å–å…¶ä¸­çš„æ¡ä»¶èŠ‚ç‚¹ã€‚

ä¸ºäº†æ–¹ä¾¿ç»„å‘˜ç¼–å†™ä¹‹åçš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œæˆ‘å°è£…äº†ä»¥ä¸‹å‡½æ•°ä¾¿äºå…¶è°ƒç”¨ï¼Œå…å»æ¯æ¬¡åˆ†æè¯­æ³•æ ‘çš„è‹¦æ¼ã€‚

###### GetSingleCondition

å•ä¸ªConditionè·å–ï¼Œä¼ å…¥kNodeCompareOperator

```cpp
  vector<string> GetSingleCondition(SyntaxNode* node){
    ASSERT(node->type_ == kNodeCompareOperator,"ERROR: Can't get condition");
```

###### GetAllConditions

éœ€è¦ï¼šä¼ å…¥çš„nodeç§ç±»ä¸ºkNodeConditions , conditions ä¸ºè·å–åˆ°æ¡ä»¶çš„å®¹å™¨ã€‚

orä½œä¸ºconnect-conditionçš„åˆ†å‰²ï¼Œé‡‡å–çš„æ–¹æ³•æ˜¯éå†è¯­æ³•æ ‘çš„childçš„èŠ‚ç‚¹ï¼Œå°†æ–°çš„connectæ”¾è‡³vectorå°¾éƒ¨ï¼ŒåŒæ—¶å…¶nextä¸ºoperatorèŠ‚ç‚¹ï¼Œå¯ä»¥ç”Ÿæˆçš„æ–°çš„conditionï¼Œå‹å…¥conditionçš„é‚£ä¸ªvecotrå°¾éƒ¨ã€‚

```cpp
void ExecuteEngine::GetAllConditions(SyntaxNode* node,vector<vector<vector<string>>> & conditions)ï¼›

```

## æµ‹è¯•æ–¹æ¡ˆå’Œæµ‹è¯•æ ·ä¾‹

### DISK AND BUFFER POOL MANAGER æ¨¡å—

#### Bitmap

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220608103649595.png" alt="image-20220608103649595" style="zoom:50%;" />

#### LRU Replacer

<img src="æŠ¥å‘Šæ¨¡ç‰ˆldy+ljy.assets/image-20220608103649595-4989881.png" alt="image-20220608103649595" style="zoom:50%;" />

### RECORD MANAGER 

#### Record and Schema

é‡‡ç”¨çš„æ˜¯tuple_test,æ¡†æ¶ä¸­åªç»™å‡ºäº†å¯¹**Filedå’ŒRow**çš„æµ‹è¯•ï¼Œè‡ªä¸»æ·»åŠ äº†å¯¹**Columnå’ŒSchemaçš„å•æµ‹**

<img src="æŠ¥å‘Šæ¨¡ç‰ˆldy+ljy.assets/image-20220608110052107.png" alt="image-20220608110052107" style="zoom:50%;" />

#### Table Heap

<img src="æŠ¥å‘Šæ¨¡ç‰ˆldy+ljy.assets/image-20220608110238913.png" alt="image-20220608110238913" style="zoom:50%;" />

### INDEX MANAGER 

#### BPlusTreePage

æœ¬éƒ¨åˆ†æ²¡æœ‰å•ç‹¬çš„æµ‹è¯•ï¼Œä¾èµ–äºb_plus_tree_testçš„æµ‹è¯•å¯ä»¥æ£€éªŒæ­£ç¡®æ€§

<img src="æŠ¥å‘Šæ¨¡ç‰ˆldy+ljy.assets/image-20220608132909713.png" alt="image-20220608132909713" style="zoom:50%;" />

### EXECUTOR MANAGER

#### Databaseæ“ä½œ

##### åˆå§‹çŠ¶æ€

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607093455433.png" alt="image-20220607093455433" style="zoom:50%;" />

##### åˆ›å»ºdatabase

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607093551340.png" alt="image-20220607093551340" style="zoom:50%;" />

##### åˆ é™¤database

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607093641016.png" alt="image-20220607093641016" style="zoom:50%;" />

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607093952653.png" alt="image-20220607093952653" style="zoom:50%;" />

##### ä½¿ç”¨database

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607094056613.png" alt="image-20220607094056613" style="zoom:50%;" />

#### Tableæ“ä½œ

##### æœªæŒ‡å®šä½¿ç”¨çš„database

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607094209828.png" alt="image-20220607094209828" style="zoom:50%;" />

##### åˆ›å»ºtable

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607094309569.png" alt="image-20220607094309569" style="zoom:50%;" />

##### åˆ é™¤table

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607094421275.png" alt="image-20220607094421275" style="zoom:50%;" />

#### ç´¢å¼•

##### show index

create table t3(a int unique,b char(20),c int ,primary key (c));

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220608164127411.png" alt="image-20220608164127411" style="zoom:50%;" />

##### create index

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220608164224735.png" alt="image-20220608164224735" style="zoom:50%;" />

##### drop index

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220608164259779.png" alt="image-20220608164259779" style="zoom:50%;" />

#### GetSingleCondition

`where b = 1;`

è¿”å›çš„ç»“æœæ˜¯ï¼š

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220606162328708.png" alt="image-20220606162328708" style="zoom:43%;" />

`where a not null;`

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220606162800469.png" alt="image-20220606162800469" style="zoom: 43%;" />

#### GetAllConditions

 `update t1 set a=1 where a=1 and b=1 and c=1 or d=1;`

<img src="æŠ¥å‘Šæ¨¡ç‰ˆ.assets/image-20220607010123123.png" alt="image-20220607010123123" style="zoom: 33%;" />



## åˆ†ç»„ä¸è®¾è®¡åˆ†å·¥

### æœ¬ç»„ååŒå¼€å‘æµç¨‹

å¯¹äºä»£ç çš„åŒæ­¥ç®¡ç†é‡‡ç”¨ZJU Gitï¼šhttps://git.zju.edu.cn/3180103721/minisql

äº¤æµä¸»è¦ä»¥çº¿ä¸Šä¸ºä¸»ï¼šå¾®ä¿¡æ²Ÿé€šã€è…¾è®¯&é’‰é’‰è§†é¢‘ä¼šè®®ã€ä»¥åŠæœ‰ä¸€æ¬¡çº¿ä¸‹debugæ´»åŠ¨

æœ¬ç»„æ°”æ°›èæ´½ï¼Œæ²Ÿé€šè¾ƒå¤šï¼Œå­¦ä¹ å¤šå¤šã€‚



### MiniSQLæ—¶é—´å®‰æ’

```mermaid
gantt
	title MiniSQLæ—¶é—´å®‰æ’å›¾
	todayMarker on
	dateformat MM-DD
	axisFormat %m-%d
	section ä»£ç å®ç°
	ç†Ÿæ‚‰æ¡†æ¶:crit,active,05-04,3d
	DISK AND BUFFER POOL :3d
	RECORD MANAGER:05-09,05-18
	INDEX MANAGER:05-21,05-28
	CATALOG MANAGER:05-09,05-19
	SQL EXECUTOR:05-09,06-09
	TEST:1d
	section æŠ¥å‘Šæ’°å†™
	æ•´ä½“æŠ¥å‘Š:06-01,06-12
	ä¸ªäººæŠ¥å‘Š:06-01,06-12
```

### åˆ†å·¥

#### æ¨¡å—ä¸€ï¼šDISK AND BUFFER POOL MANAGER (åˆä½œ)

```mermaid
flowchart TD
		å•ä¸¹ç‘œ --> bitmap
		å•ä¸¹ç‘œ --> lru_replacer
		æ—ç‚¬ä¹™ --> disk_manager
		é™†å¤© --> buffer_pool_manager
    subgraph part1
    bitmap 
    disk_manager
    lru_replacer
    buffer_pool_manager
    end
    



```

#### æ¨¡å—äºŒï¼šRECORD MANAGER(ä¸ªäºº)

è´Ÿè´£ï¼šå•ä¸¹ç‘œ

#### æ¨¡å—ä¸‰ï¼šINDEX MANAGERï¼ˆåˆä½œï¼‰

```mermaid
flowchart TD
		å•ä¸¹ç‘œ --> b_plus_tree_page
		é™†å¤© --> b_plus_tree_index
		æ—ç‚¬ä¹™ --> index_iterator
    subgraph part3
    b_plus_tree_page
    b_plus_tree_index
    index_iterator
    end
```

#### æ¨¡å—å››ï¼šCATALOG MANAGER(ä¸ªäºº)

è´Ÿè´£ï¼šé™†å¤©

#### æ¨¡å—äº”ï¼šSQL EXECUTORï¼ˆåˆä½œï¼‰

```mermaid
flowchart TD
		å•ä¸¹ç‘œ --> database&table
		å•ä¸¹ç‘œ --> show/create_indexes
		å•ä¸¹ç‘œ --> output&condition
		æ—ç‚¬ä¹™ --> select/insert/update/drop
		æ—ç‚¬ä¹™ --> Execfile
		æ—ç‚¬ä¹™ --> nonviolate_storage
		é™†å¤© --> nonviolate_storage
    subgraph part5
    show/create_indexes
    database&table
    output&condition
    select/insert/update/drop
    nonviolate_storage
    Execfile
    end
```

## æœ¬ç»„ç‰¹è‰²



## å»ºè®®

### å•ä¸¹ç‘œ	

â€‹	è¿™æ˜¯è¯¾ç¨‹ç»„ç¬¬ä¸€æ¬¡é‡‡ç”¨æ¡†æ¶è®©æˆ‘ä»¬ç¼–å†™æ•°æ®åº“ï¼Œä¹‹å‰åœ¨å¯’å‡å°±å¬è¯´äº†CMUçš„databaseè¯¾ç¨‹å¤§ä½œä¸šå¾ˆå¥½ï¼Œæ²¡æƒ³åˆ°å¦‚ä»Šèƒ½ç”¨ä¸ŠZJUä¸“å±çš„MiniSQLæ¡†æ¶ã€‚ä½†æ˜¯è¯¥æ¡†æ¶ä¹Ÿå­˜åœ¨ç€ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å•æµ‹è¿è¡Œæ£€æµ‹çš„ä¸å¤Ÿå…¨é¢ï¼Œç¬¬äºŒä¸ªæ˜¯å¦‚æœæ˜¯ä½œä¸ºå°ç»„ä½œä¸šåˆ†å·¥çš„è¯ä¼šæ¯”è¾ƒéš¾åŠï¼Œå› ä¸ºä¹‹åçš„æ¨¡å—çš„åŒå­¦éœ€è¦ä¾èµ–äºå‰é¢çš„åŒå­¦ï¼ŒååŒå¼€å‘æ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œå¯èƒ½æ›´å¥½çš„æ–¹æ³•æ˜¯ä¸€ä¸ªäººåšå®Œå…¨éƒ¨ï¼Œæ‰ä¼šå¯¹æ•´ä¸ªæ¡†æ¶ååˆ†ç†Ÿæ‚‰ï¼Œä½†é‚£æ ·å­çš„è¯å·¥ä½œé‡åˆæ¯”è¾ƒå¤§äº†ã€‚ç„¶åï¼Œé’ˆå¯¹ç¬¬äº”æ¨¡å—çš„æŒ‡å¯¼æ¯”è¾ƒå°‘ï¼Œåœ¨å†™çš„æ—¶å€™ä¼šæ¯”è¾ƒæ‡µé€¼ï¼Œå»ºè®®ä¹‹åå¢åŠ å¯¹ç¬¬äº”æ¨¡å—çš„æŒ‡å¯¼ã€‚

